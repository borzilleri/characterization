<?php
$css_include = array('statBlock.css', 'powerBox.css');
$js_include = array('playerProcess.js');
include('autohandler.php');

if( !$char ) {
  loadPage('/');
}

$power_list = Doctrine_Query::create()
  ->from('Power p')
  ->where('p.player_id = ?', $char->id)
  ->orderBy('p.useType, p.level')
  ->execute();
?>

<script type="text/javascript" charset="utf-8">
  var CHAR_ID = <?=$char->id;?>;
</script>

<form method="post" action="<?=SITE_URL;?>/update">
<div id="PlayerTitle">
  <input type="hidden" name="id" value="<?=$char->id;?>" />
  <span id="playerName"><?=$char->name;?></span>
  &mdash;
  <span id="playerArchetype">
    <?=$char->Race->name;?>
    <?=$char->Archetype->name;?>
    <?=$char->level;?>
  </span>
  <select name="action">
    <option value="shortRest">Short</option>
    <option value="extendedRest">Extended</option>
  </select>
  <input type="submit" value="Rest" />
</div>
</form>

<form method="post" action="<?=SITE_URL;?>/update">
<div id="health">Health:
  <input type="hidden" name="id" value="<?=$char->id;?>" />

  <span class="<?=$char->isBloodied()?'bloodied':'';?>">
    <?=$char->health_cur;?>
  </span>
  &nbsp;/&nbsp;<?=$char->health_max;?>
  <?=$char->health_tmp?" ({$char->health_tmp})":'';?>
  <input type="text" name="health" size="3" maxlength="4" value="0" />
  <select name="action">
    <option value="damage">Damage</option>
    <option value="tempHealth">Temp. Health</option>
  </select>
  <input type="submit" value="Adjust Health" />
</div>
</form>

<form method="post" action="<?=SITE_URL;?>/update">
<div id="surges">Surges:
  <input type="hidden" name="id" value="<?=$char->id;?>" />
  <input type="hidden" name="action" value="surge" />

  <span id="surges_cur"><?=$char->surges_cur;?></span>
  &nbsp;/&nbsp;<?=$char->surges_max;?> (<?=$char->surge_value;?>)
  <input type="button" id="surgeMinus" value="-" />
  <input type="button" id="surgePlus" value="+" />
  
  <input type="submit" value="Spend Surge" />
  +<input type="text" name="surge_bonus" size="3" maxlength="4" value="0" />
</div>
</form>

<div>
  <span class="abilityLabel">Str:</span>
    <?=$char->strength;?>(<?=$char->getMod('str');?>)
  <span class="abilityLabel">Con:</span>
    <?=$char->constitution;?>(<?=$char->getMod('con');?>)
  <span class="abilityLabel">Dex:</span>
    <?=$char->dexterity;?>(<?=$char->getMod('dex');?>)
  <span class="abilityLabel">Int:</span>
    <?=$char->intelligence;?>(<?=$char->getMod('int');?>)
  <span class="abilityLabel">Wis:</span>
    <?=$char->wisdom;?>(<?=$char->getMod('wis');?>)
  <span class="abilityLabel">Cha:</span>
    <?=$char->charisma;?>(<?=$char->getMod('cha');?>)
</div>

<hr />

<form method="post" action="<?=SITE_URL;?>/update">
<div id="notesBox">
  <input type="hidden" name="id" value="<?=$char->id;?>" />
  <input type="hidden" name="action" value="notes" />
  <input type="submit" value="Update Notes" />
  <br />
  <textarea name="notes" rows="30" cols="42"><?=$char->notes;?></textarea>
</div>
</form>

<div id="powerList">
<? foreach($power_list as $power): ?>
  <div class="power" id="powerBox<?=$power->id;?>">
    <div id="p<?=$power->id;?>" class="titleBar
      <?=$power->useTypeClass();?>">
      <span class="powerLevel">
        <?=$char->Archetype->name;?> <?=$power->level;?>
      </span>
      <span class="powerTitle"><?=$power->name;?></span>
    </div>
    <div class="description <?=$power->used?'usedPower':'';?>">
      <div class="row0">
        <div>
          <span class="usage"><?=ucfirst($power->useType);?></span>
          &diams;
          <span class="keywords">[keywords]</span>
        </div>
        <div>
          <? if( !empty($power->powerRange) ): ?>
            <span class="range"><?=$power->powerRange;?></span>
          <? endif; ?>
          <span class="actionType"><?=$power->actionTypeDisplay();?></span>
        </div>
      <? if( !empty($power->target) ): ?>
        <div><span class="target">Target:</span> <?=$power->target;?></div>
      <? endif; ?>
      <? if( !empty($power->attack) ): ?>
        <div><span class="attack">Attack:</span> <?=$power->attack;?></div>
      <? endif; ?>
      </div>
      <div class="row1">
        <div><?=nl2br($power->notes);?></div>
      </div>
    </div>
  </div>
<? endforeach; ?>
</div>
<div class="clear" />

<?php include('footer.php'); ?>
