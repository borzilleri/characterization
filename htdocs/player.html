<?php
$css_include = array('statBlock.css', 'powerBox.css');
$js_include = array('playerProcess.js');
include('autohandler.php');

if( !$char ) {
  loadPage('/');
}

$power_list = Doctrine_Query::create()
  ->from('Power p')
  ->where('p.player_id = ?', $char->id)
  ->orderBy('p.use_type, p.level')
  ->execute();
?>

<script type="text/javascript" charset="utf-8">
  var CHAR_ID = <?=$char->id;?>;
</script>

<form method="post" action="<?=SITE_URL;?>/update">
<div id="PlayerTitle">
  <input type="hidden" name="id" value="<?=$char->id;?>" />
  <span id="playerName"><?=$char->name;?></span>
  &mdash;
  <span id="playerArchetype">
    <?=$char->Race->name;?>
    <?=$char->Archetype->name;?>
    <?=$char->level;?>
  </span>
  <select name="action">
    <option value="shortRest">Short</option>
    <option value="extendedRest">Extended</option>
  </select>
  <input type="submit" value="Rest" />
</div>
</form>

<form method="post" action="<?=SITE_URL;?>/update">
<div id="health">Health:
  <input type="hidden" name="id" value="<?=$char->id;?>" />

  <span class="<?=$char->isBloodied()?'bloodied':'';?>">
    <?=$char->health_cur;?>
  </span>
  &nbsp;/&nbsp;<?=$char->health_max;?>
  <?=$char->health_tmp?" ({$char->health_tmp})":'';?>
  <input type="text" name="health" size="3" maxlength="4" value="0" />
  <select name="action">
    <option value="damage">Damage</option>
    <option value="tempHealth">Temp. Health</option>
  </select>
  <input type="submit" value="Adjust Health" />
</div>
</form>

<form method="post" action="<?=SITE_URL;?>/update">
<div id="surges">Surges:
  <input type="hidden" name="id" value="<?=$char->id;?>" />
  <input type="hidden" name="action" value="surge" />

  <span id="surges_cur"><?=$char->surges_cur;?></span>
  &nbsp;/&nbsp;<?=$char->surges_max;?> (<?=$char->surge_value;?>)
  <input type="button" id="surgeMinus" value="-" />
  <input type="button" id="surgePlus" value="+" />
  
  <input type="submit" value="Spend Surge" />
  +<input type="text" name="surge_bonus" size="3" maxlength="4" value="0" />
</div>
</form>

<div id="apoints">Action Points:
  <span id="action_points"><?=$char->action_points;?></span>
  <input type="button" id="apMinus" value="-" />
  <input type="button" id="apPlus" value="+" />
</div>

<div>
  <span class="abilityLabel">Str:</span>
    <?=$char->strength;?>(<?=$char->getMod('str');?>)
  <span class="abilityLabel">Con:</span>
    <?=$char->constitution;?>(<?=$char->getMod('con');?>)
  <span class="abilityLabel">Dex:</span>
    <?=$char->dexterity;?>(<?=$char->getMod('dex');?>)
  <span class="abilityLabel">Int:</span>
    <?=$char->intelligence;?>(<?=$char->getMod('int');?>)
  <span class="abilityLabel">Wis:</span>
    <?=$char->wisdom;?>(<?=$char->getMod('wis');?>)
  <span class="abilityLabel">Cha:</span>
    <?=$char->charisma;?>(<?=$char->getMod('cha');?>)
</div>

<hr />

<form method="post" action="<?=SITE_URL;?>/update">
<div id="notesBox">
  <input type="hidden" name="id" value="<?=$char->id;?>" />
  <input type="hidden" name="action" value="notes" />
  <input type="submit" value="Update Notes" />
  <br />
  <textarea name="notes" rows="30" cols="42"><?=$char->notes;?></textarea>
</div>
</form>

<div id="powerList">
<? foreach($power_list as $power): $i=0; ?>
  <div class="power" id="powerBox<?=$power->id;?>">
    <div id="p<?=$power->id;?>" class="titleBar
      <?=$power->getDisplayUseType()?>">
      <span class="powerLevel">
        <?=$char->Archetype->name;?> <?=$power->level;?>
      </span>
      <span class="powerTitle"><?=$power->name;?></span>
    </div>
    <div class="description <?=$power->used?'usedPower':'';?>">
      <div class="row<?=$i; $i=($i+1)%2?>">
        <div>
          <span class="usage"><?=$power->getDisplayUseType();?></span>
          <? if(0<$power->Keywords->count()): ?>&diams;
          <span class="keywords"><?
            echo $power->Keywords[0]->name;
            for($k=1;$k<$power->Keywords->count();$k++):
              echo ", {$power->Keywords[$k]->name}";
            endfor; ?>
          </span>
          <? endif; ?>
        </div>
        <div>
          <? if( !empty($power->power_range) ): ?>
            <span class="range"><?=$power->power_range;?></span>
          <? endif; ?>
          <span class="actionType"><?=$power->actionTypeDisplay();?></span>
        </div>
      <? if( !empty($power->target) ): ?>
        <div><span class="target">Target:</span> <?=$power->target;?></div>
      <? endif; ?>
        
        <? if( 'none'!=$power->attack_ability): ?>
        <div>
          <span class="attack">Attack:</span>          
          +<?=$power->attack_bonus;?> (<?=$power->attack_ability;?>)
          vs. <?=$power->defense;?>
        </div>
        <? endif; ?>
      </div>
      
      <? if(!empty($power->hit)): ?>
      <div class="row<?=$i; $i=($i+1)%2;?>" id="p<?=$power->id;?>hit">
        <label>Hit:</label>
        <span><?=nl2br($power->hit);?></span>
      </div>
      <? endif; ?>
      
      <? if(!empty($power->miss)): ?>
      <div class="row<?=$i; $i=($i+1)%2;?>" id="p<?=$power->id;?>miss">
        <label>Miss:</label>
        <span><?=nl2br($power->miss);?></span>
      </div>
      <? endif; ?>
      
      <? if(!empty($power->effect)): ?>
      <div class="row<?=$i; $i=($i+1)%2;?>" id="p<?=$power->id;?>effect">
        <label>Effect:</label>
        <span><?=nl2br($power->effect);?></span>
      </div>
      <? endif; ?>
      
      <? if('none'!=$power->sustain_action): ?>
      <div class="row<?=$i; $i=($i+1)%2;?>" id="p<?=$power->id;?>sustain">
        <label>Sustain <?=$power->sustain_action;?>:</label>
        <span><?=nl2br($power->sustain);?></span>
      </div>
      <? endif; ?>
      
      <? if(!empty($power->notes)): ?>
      <div class="row<?=$i; $i=($i+1)%2;?>">
        <label>Notes:</label>
        <span><?=nl2br($power->notes);?></span>
      </div>
      <? endif; ?>
    </div>
  </div>
<? endforeach; ?>
</div>
<div class="clear" />

<?php include('footer.php'); ?>
